<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEXGN Script Writer Pro v17.0</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22 font-weight=%22bold%22 fill=%22%23d4af37%22>N</text></svg>">

    <style>
        :root {
            --primary: #d4af37; /* Gold */
            --bg: #050505;
            --card: #141414;
            --text: #e0e0e0;
            --border: #333;
            --success: #00e676;
            --error: #ff5252;
        }

        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; height: 100vh; overflow: hidden; }
        .hidden { display: none !important; }
        button { cursor: pointer; }

        /* Animations */
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .reel-icon { display: inline-block; font-size: 24px; margin-left: 10px; animation: spin 4s linear infinite; vertical-align: middle; }
        
        /* Blinking Red/Green Indicator */
        @keyframes flashRedGreen { 
            0% { background-color: var(--success); box-shadow: 0 0 10px var(--success); } 
            50% { background-color: var(--error); box-shadow: 0 0 10px var(--error); } 
            100% { background-color: var(--success); box-shadow: 0 0 10px var(--success); } 
        }
        .has-data::after {
            content: ''; position: absolute; top: 8px; left: 8px;
            width: 10px; height: 10px; border-radius: 50%;
            animation: flashRedGreen 1s infinite;
        }

        /* Login Screen */
        #login-wrapper {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at center, #222 0%, #000 70%); z-index: 1000;
            display: flex; align-items: center; justify-content: center;
        }
        .login-box {
            background: var(--card); padding: 40px; border-radius: 12px;
            border: 1px solid var(--primary); text-align: center; width: 400px;
            box-shadow: 0 0 30px rgba(212, 175, 55, 0.2);
        }
        .login-input { width: 100%; padding: 12px; margin-bottom: 15px; background: #222; border: 1px solid #444; color: #fff; border-radius: 6px; box-sizing: border-box; }
        .login-btn { width: 100%; padding: 12px; background: var(--primary); color: #000; font-weight: bold; border: none; border-radius: 6px; transition: 0.3s; }
        .login-btn:hover { background: #fff; }

        /* Dashboard */
        .app-shell { max-width: 1200px; margin: 20px auto; background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 20px; height: 90vh; display: flex; flex-direction: column; position: relative; }
        
        /* NEXGN Watermark */
        .nexgn-watermark {
            position: absolute;
            top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 150px; font-weight: 900;
            color: rgba(255, 255, 255, 0.03);
            pointer-events: none; z-index: 0;
            letter-spacing: 10px; user-select: none;
        }

        .header { 
            text-align: center; padding-bottom: 15px; border-bottom: 1px solid var(--border); 
            margin-bottom: 15px; z-index: 2; position: relative; 
        }
        
        .title-row { display: flex; justify-content: center; align-items: center; margin-bottom: 10px; }
        h1 { margin: 0; font-size: 24px; background: linear-gradient(45deg, #fff, var(--primary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        /* Testimonial Box */
        .testimonial-box {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid #333;
            border-radius: 20px;
            padding: 8px 20px;
            display: inline-block;
            margin-top: 5px;
            min-width: 400px;
            max-width: 600px;
        }
        .testimonial-text {
            color: #ffd700; /* Yellow text */
            font-style: italic;
            font-size: 13px;
            animation: fade 10s infinite; /* 10s per testimonial */
        }
        @keyframes fade { 0% { opacity: 0; } 10% { opacity: 1; } 90% { opacity: 1; } 100% { opacity: 0; } }

        .user-controls { position: absolute; right: 0; top: 0; display: flex; align-items: center; gap: 15px; }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary); cursor: pointer; }
        
        /* Profile Menu */
        #profile-menu {
            position: absolute; top: 60px; right: 0; background: #1a1a1a;
            border: 1px solid var(--primary); border-radius: 8px; width: 250px;
            padding: 15px; display: none; z-index: 9999; 
            box-shadow: 0 5px 20px rgba(0,0,0,0.9);
        }
        #profile-menu h4 { margin: 0 0 10px 0; color: var(--primary); font-size: 14px; border-bottom: 1px solid #333; padding-bottom: 5px; }
        #profile-menu button { width: 100%; padding: 10px; text-align: left; background: transparent; border: none; color: #fff; border-bottom: 1px solid #333; cursor: pointer; }
        #profile-menu button:hover { background: #333; }
        .key-section { margin-bottom: 10px; }
        .key-input { width: 100%; background: #000; border: 1px solid #444; color: var(--success); padding: 8px; border-radius: 4px; font-family: monospace; box-sizing: border-box; }

        /* Tabs */
        .nav-tabs { display: flex; gap: 5px; margin-bottom: 15px; z-index: 1; position: relative; }
        .tab-btn { flex: 1; padding: 12px; background: #111; border: 1px solid #333; color: #888; border-radius: 6px; transition: 0.3s; position: relative; }
        .tab-btn.active { background: var(--primary); color: #000; font-weight: bold; border-color: var(--primary); }
        .tab-btn:hover { background: #222; color: #fff; }

        .tab-content { display: none; padding: 10px; flex-grow: 1; overflow-y: auto; z-index: 1; position: relative; display: flex; flex-direction: column; height: 100%;}
        .tab-content.active { display: block; }

        /* Inputs */
        .input-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        .full-width { grid-column: span 3; }
        label { display: block; font-size: 11px; color: var(--primary); margin-bottom: 5px; font-weight: bold; }
        input, select, textarea { width: 100%; background: #222; border: 1px solid var(--border); color: #fff; padding: 10px; border-radius: 6px; box-sizing: border-box; }
        
        .action-btn { width: 100%; padding: 15px; background: var(--primary); color: #000; font-weight: bold; border: none; border-radius: 6px; font-size: 16px; margin-top: 10px; margin-bottom: 15px; }
        
        /* STATIC TOOLBAR */
        .toolbar { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 10px; background: #1a1a1a; border: 1px solid var(--border);
            border-bottom: none; border-radius: 8px 8px 0 0; position: sticky; top: 0; z-index: 10;
        }
        .history-select { background: #000; color: #aaa; border: 1px solid #444; padding: 5px; border-radius: 4px; font-size: 12px; width: 250px; }
        .sm-btn { background: #333; color: #fff; padding: 5px 10px; border-radius: 4px; border: 1px solid #555; font-size: 12px; }
        .del-btn { background: #b00020; border-color: #790000; color: white; padding: 5px 10px; border-radius: 4px; cursor: pointer; }

        /* Output Box */
        .output-box { 
            background: #000; border: 1px solid var(--border); padding: 25px; 
            border-radius: 0 0 8px 8px; min-height: 300px; 
            white-space: pre-wrap; font-family: 'Courier New', monospace; 
            color: #ccc; font-size: 15px; line-height: 1.6; 
        }
        .loader { display: none; text-align: center; color: var(--primary); margin-top: 10px; font-weight: bold; animation: pulse 1s infinite; }
        @keyframes pulse { 50% { opacity: 0.5; } }

        /* Modal */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: none; align-items: center; justify-content: center; }
        .modal-box { background: #1a1a1a; padding: 30px; border-radius: 10px; width: 300px; text-align: center; border: 1px solid var(--primary); }
    </style>
</head>
<body>

<div id="login-wrapper">
    <div class="login-box">
        <h2>NEXGN SCRIPT WRITER PRO v17.0 <span class="reel-icon">üéûÔ∏è</span></h2>
        <input type="text" id="loginUser" class="login-input" placeholder="Username">
        <input type="password" id="loginPass" class="login-input" placeholder="Password">
        <button class="login-btn" onclick="handleLogin()">LOGIN</button>
        <div id="loginError" style="color:var(--error); margin-top:10px;"></div>
    </div>
</div>

<div class="app-shell hidden" id="app-main">
    <div class="nexgn-watermark">NEXGN</div>
    
    <div class="header">
        <div style="flex-grow:1; text-align: center;">
            <div class="title-row">
                <h1>NEXGN Script Writer Pro <span class="reel-icon">üéûÔ∏è</span></h1>
            </div>
            <div class="testimonial-box">
                <div id="testimonialText" class="testimonial-text">"NEXGN Script Writer changed my filmmaking career!" - Rohan K.</div>
            </div>
        </div>

        <div class="user-controls">
            <img id="userAvatarDisplay" src="https://api.dicebear.com/7.x/avataaars/svg?seed=User" class="user-avatar" onclick="toggleProfileMenu()">
            
            <div id="profile-menu">
                <h4>Profile & Settings</h4>
                <div class="key-section">
                    <label>Insert key here</label>
                    <input type="password" id="apiKey" class="key-input" placeholder="Enter API Key" onchange="saveKey()">
                </div>
                <button onclick="openPhotoModal()">üì∑ Change Photo</button>
                <button onclick="openPassModal()">üîë Change Password</button>
                <button onclick="logout()" style="color:var(--error)">üö™ Logout</button>
            </div>
        </div>
    </div>

    <div class="nav-tabs">
        <button class="tab-btn active" onclick="openTab('film')">üé¨ Short Film Scripter</button>
        <button class="tab-btn" id="btn-cinematography" onclick="openTab('cinematography')">üé• Cinematography</button>
        <button class="tab-btn" id="btn-dialogue" onclick="openTab('dialogue')">üó£Ô∏è Dialogue Writer</button>
        <button class="tab-btn" onclick="openTab('improve')">‚ú® Script Improvement</button>
        <button class="tab-btn" onclick="openTab('youtube')">üìπ YouTube Scripter</button>
    </div>

    <datalist id="languageOptions">
        <option value="English">English</option>
        <option value="Hinglish">Hinglish</option>
        <option value="Hindi">Hindi (‡§π‡§ø‡§®‡•ç‡§¶‡•Ä)</option>
        <option value="Marathi">Marathi (‡§Æ‡§∞‡§æ‡§†‡•Ä)</option>
        <option value="Bengali">Bengali (‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ)</option>
        <option value="Tamil">Tamil (‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç)</option>
        <option value="Telugu">Telugu (‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å)</option>
        <option value="Gujarati">Gujarati (‡™ó‡´Å‡™ú‡™∞‡™æ‡™§‡´Ä)</option>
        <option value="Urdu">Urdu (ÿßÿ±ÿØŸà)</option>
        <option value="Kannada">Kannada (‡≤ï‡≤®‡≥ç‡≤®‡≤°)</option>
        <option value="Odia">Odia (‡¨ì‡¨°‡¨º‡¨ø‡¨Ü)</option>
        <option value="Malayalam">Malayalam (‡¥Æ‡¥≤‡¥Ø‡¥æ‡¥≥‡¥Ç)</option>
        <option value="Punjabi">Punjabi (‡®™‡©∞‡®ú‡®æ‡®¨‡©Ä)</option>
        <option value="Assamese">Assamese (‡¶Ö‡¶∏‡¶Æ‡ßÄ‡¶Ø‡¶º‡¶æ)</option>
        <option value="Maithili">Maithili (‡§Æ‡•à‡§•‡§ø‡§≤‡•Ä)</option>
        <option value="Santali">Santali (‡§∏‡§Ç‡§•‡§æ‡§≤‡•Ä)</option>
        <option value="Kashmiri">Kashmiri (‡§ï‡§∂‡•ç‡§Æ‡•Ä‡§∞‡•Ä)</option>
        <option value="Nepali">Nepali (‡§®‡•á‡§™‡§æ‡§≤‡•Ä)</option>
        <option value="Konkani">Konkani (‡§ï‡•ã‡§Ç‡§ï‡§£‡•Ä)</option>
        <option value="Sindhi">Sindhi (‡§∏‡§ø‡§Ç‡§ß‡•Ä)</option>
        <option value="Dogri">Dogri (‡§°‡•ã‡§ó‡§∞‡•Ä)</option>
        <option value="Manipuri">Manipuri (‡¶Æ‡¶£‡¶ø‡¶™‡ßÅ‡¶∞‡ßÄ)</option>
        <option value="Bodo">Bodo (‡§¨‡§∞')</option>
        <option value="Sanskrit">Sanskrit (‡§∏‡§Ç‡§∏‡•ç‡§ï‡•É‡§§)</option>
    </datalist>

    <div id="film" class="tab-content active">
        <div class="input-grid">
            <div class="full-width"><label>Movie Idea</label><textarea id="filmIdea" rows="2" placeholder="e.g. A young boy finds a magical flute..."></textarea></div>
            <div><label>Genre</label><select id="filmGenre">
                <option>Drama</option><option>Sci-Fi</option><option>Horror</option><option>Comedy</option><option>Thriller</option><option>Romance</option>
                <option>Action</option><option>Animation</option><option>Fantasy</option><option>Mystery</option><option>Historical</option><option>Noir</option>
            </select></div>
            <div><label>Duration</label><select id="filmDuration"><option>10 Minutes</option><option>15 Minutes</option><option>20 Minutes</option><option>25 Minutes</option><option>30 Minutes</option><option>35 Minutes</option><option>40 Minutes</option></select></div>
            <div><label>Language</label><input list="languageOptions" id="filmLanguage" placeholder="Select Language"></div>
        </div>
        <button class="action-btn" onclick="generateFilm()">GENERATE SCRIPT + AUTO CINEMATOGRAPHY</button>
        <div id="filmLoader" class="loader">WRITING SCREENPLAY...</div>
        
        <div class="toolbar">
            <select id="hist-film" class="history-select" onchange="restoreHistory('film')"><option value="">üïí Recent Scripts</option></select>
            <button class="del-btn" onclick="deleteHistoryItem('film')">‚ùå</button>
            <button class="sm-btn" onclick="clearArea('filmOutput', 'filmIdea')">üóëÔ∏è Clear</button>
            <button class="sm-btn" onclick="printArea('filmOutput')">üñ®Ô∏è Print</button>
            <button class="sm-btn" onclick="copyText('filmOutput')">üìã Copy</button>
        </div>
        <div id="filmOutput" class="output-box"></div>
    </div>

    <div id="cinematography" class="tab-content">
        <div class="input-grid">
            <div class="full-width"><label>Script Context</label><textarea id="cineContext" rows="3"></textarea></div>
            <div><label>Language</label><input list="languageOptions" id="cineLanguage"></div>
        </div>
        <button class="action-btn" onclick="generateCinematography()">GENERATE SHOT LIST</button>
        <div id="cineLoader" class="loader">PLANNING SHOTS...</div>
        
        <div class="toolbar">
            <select id="hist-cine" class="history-select" onchange="restoreHistory('cine')"><option value="">üïí Recent Scripts</option></select>
            <button class="del-btn" onclick="deleteHistoryItem('cine')">‚ùå</button>
            <button class="sm-btn" onclick="clearArea('cineOutput', 'cineContext')">üóëÔ∏è Clear</button>
            <button class="sm-btn" onclick="printArea('cineOutput')">üñ®Ô∏è Print</button>
            <button class="sm-btn" onclick="copyText('cineOutput')">üìã Copy</button>
        </div>
        <div id="cineOutput" class="output-box"></div>
    </div>

    <div id="dialogue" class="tab-content">
        <div class="input-grid">
            <div class="full-width"><label>Context</label><textarea id="diaContext" rows="3" placeholder="Context..."></textarea></div>
            <div><label>Language</label><input list="languageOptions" id="diaLanguage" placeholder="Select Language"></div>
        </div>
        <button class="action-btn" onclick="generateDialogue()">GENERATE DIALOGUES</button>
        <div id="diaLoader" class="loader">WRITING...</div>
        
        <div class="toolbar">
            <select id="hist-dia" class="history-select" onchange="restoreHistory('dia')"><option value="">üïí Recent Scripts</option></select>
            <button class="del-btn" onclick="deleteHistoryItem('dia')">‚ùå</button>
            <button class="sm-btn" onclick="clearArea('diaOutput', 'diaContext')">üóëÔ∏è Clear</button>
            <button class="sm-btn" onclick="printArea('diaOutput')">üñ®Ô∏è Print</button>
            <button class="sm-btn" onclick="copyText('diaOutput')">üìã Copy</button>
        </div>
        <div id="diaOutput" class="output-box"></div>
    </div>

    <div id="improve" class="tab-content">
        <div class="input-grid">
            <div class="full-width"><label>Paste Existing Script</label><textarea id="improveInput" rows="5"></textarea></div>
            <div><label>Instruction</label><select id="improveType">
                <option>Fix Grammar & Punctuation</option>
                <option>Make Dialogues More Emotional</option>
                <option>Tighten Pacing</option>
                <option>Format as Professional Screenplay</option>
            </select></div>
            <div><label>Target Language</label><input list="languageOptions" id="improveLang" placeholder="Select"></div>
        </div>
        <button class="action-btn" onclick="improveScript()">IMPROVE & TRANSLATE</button>
        <div id="improveLoader" class="loader">POLISHING...</div>
        
        <div class="toolbar">
            <select id="hist-imp" class="history-select" onchange="restoreHistory('imp')"><option value="">üïí Recent Scripts</option></select>
            <button class="del-btn" onclick="deleteHistoryItem('imp')">‚ùå</button>
            <button class="sm-btn" onclick="clearArea('improveOutput', 'improveInput')">üóëÔ∏è Clear</button>
            <button class="sm-btn" onclick="printArea('improveOutput')">üñ®Ô∏è Print</button>
            <button class="sm-btn" onclick="copyText('improveOutput')">üìã Copy</button>
        </div>
        <div id="improveOutput" class="output-box"></div>
    </div>

    <div id="youtube" class="tab-content">
        <div class="input-grid">
            <div class="full-width"><label>Title</label><input type="text" id="ytTopic"></div>
            <div><label>Duration</label><select id="ytDuration"><option>10 Min</option><option>15 Min</option><option>20 Min</option><option>25 Min</option><option>30 Min</option></select></div>
            <div><label>Category</label><select id="ytCategory">
                <option>Tech Review</option><option>Vlog</option><option>Documentary</option><option>Gaming</option><option>Tutorial</option>
                <option>Comedy</option><option>Horror Stories</option><option>Finance</option><option>History</option><option>Science</option>
                <option>True Crime</option><option>ASMR</option><option>Cooking</option><option>Fitness</option><option>Travel Guide</option>
                <option>DIY / Crafts</option><option>Productivity</option><option>Meditation</option><option>News / Commentary</option>
                <option>Movie Review</option><option>Psychology</option>
            </select></div>
            <div><label>Language</label><input list="languageOptions" id="ytLanguage"></div>
        </div>
        <button class="action-btn" onclick="generateYouTube()">GENERATE SCRIPT</button>
        <div id="ytLoader" class="loader">WRITING...</div>
        <div class="toolbar">
            <select id="hist-yt" class="history-select" onchange="restoreHistory('yt')"><option value="">üïí Recent Scripts</option></select>
            <button class="del-btn" onclick="deleteHistoryItem('yt')">‚ùå</button>
            <button class="sm-btn" onclick="clearArea('ytOutput', 'ytTopic')">üóëÔ∏è Clear</button>
            <button class="sm-btn" onclick="printArea('ytOutput')">üñ®Ô∏è Print</button>
            <button class="sm-btn" onclick="copyText('ytOutput')">üìã Copy</button>
        </div>
        <div id="ytOutput" class="output-box"></div>
    </div>

</div>

<div id="passModal" class="modal">
    <div class="modal-box">
        <h3>Change Password</h3>
        <input type="password" id="newPassInput" class="login-input" placeholder="New Password">
        <button class="login-btn" onclick="saveNewPassword()">Save</button>
        <button class="login-btn" style="background:#333; margin-top:10px;" onclick="closeModals()">Cancel</button>
    </div>
</div>

<div id="photoModal" class="modal">
    <div class="modal-box">
        <h3>Upload Photo</h3>
        <input type="file" id="photoInput" class="login-input" accept="image/*">
        <button class="login-btn" onclick="savePhoto()">Upload</button>
        <button class="login-btn" style="background:#333; margin-top:10px;" onclick="closeModals()">Cancel</button>
    </div>
</div>

<script>
    let currentUser = null;

    // --- 50+ TESTIMONIALS ---
    const testimonials = [
        "NEXGN Script Writer changed my filmmaking career! - Rohan K.",
        "Best AI tool for dialogue writing. Highly recommended. - Priya S.",
        "The cinematography shot lists are a game changer. - Amit D.",
        "Finally, a tool that supports Assamese script perfectly! - Manash B.",
        "My YouTube workflow is 10x faster now. - TechGuru",
        "The script formatting is industry standard. Amazing. - Suresh M.",
        "Hinglish support is exactly what I needed for my web series. - Anjali P.",
        "Best AI script tool for Indian filmmakers. - Director X",
        "It handles Marathi dialects surprisingly well. - Vijay T.",
        "The shot lists are very creative and detailed. - DOP Sarah",
        "I use this daily for my Instagram Reels. - Influencer123",
        "The script improvement tab fixed my rough draft instantly. - Writer Joe",
        "Clean interface, no ads, just pure productivity. - User99",
        "Love the dark mode and professional look. - Editor Sam",
        "Supports so many regional languages! A must-have. - Ravi L.",
        "The Bengali scripts feel very natural. - Dipankar G.",
        "Great for brainstorming horror concepts. - ScaredyCat",
        "The documentary structure logic is solid. - DocuMaker",
        "Highly recommended for student filmmakers. - FilmStudent",
        "Simple, fast, and effective. - Minimalist",
        "The Tamil dialogue generation is spot on. - Kartik",
        "Helped me win a local short film contest! - Winner22",
        "The auto-save history feature is a lifesaver. - ForgetfulFred",
        "I love how it separates scenes clearly. - ScriptDoc",
        "Formatting is perfect for PDF export. - PrintMaster",
        "The horror prompts give me chills. - GhostHunter",
        "Comedy scripts actually have good timing. - FunnyBone",
        "Better than ChatGPT for screenplays. - AI_Fan",
        "The admin panel security is a nice touch. - SysAdmin",
        "Works great on my iPad too. - MobileUser",
        "Punjabi scripts are fantastic! - SinghIsKing",
        "The duration estimator is quite accurate. - TimeKeeper",
        "Love the new V17 update! - EarlyAdopter",
        "Makes pre-production so much smoother. - Producer Pam",
        "The drone shot suggestions are epic. - SkyHigh",
        "Urdu poetry scripts come out beautiful. - PoetSoul",
        "Handles complex sci-fi jargon easily. - SciFiNerd",
        "The romance scripts are cheesy but good! - LoveGuru",
        "Action sequences are well described. - StuntMan",
        "Great for non-English speakers. - GlobalUser",
        "The formatting follows Hollywood standards. - HW_Dreamer",
        "Kannada scripts are very authentic. - KarnatakaBoy",
        "Odia support is rare and appreciated. - OdishaLove",
        "Fastest way to get a first draft. - SpeedWriter",
        "The login system keeps my work private. - PrivacyFirst",
        "Customer support is responsive. - HelpDesk",
        "Worth every penny (even though it's free!). - FrugalFilmmaker",
        "The best tool for Indian content creators. - CreatorHub",
        "I generated 5 scripts in one hour. Insane. - PowerUser",
        "NEXGN is the future of writing. - Futurist"
    ];

    window.onload = () => {
        const sessionUser = localStorage.getItem('nisff_current_user');
        if (sessionUser) {
            currentUser = sessionUser;
            initApp();
        }
        
        const key = localStorage.getItem('nisff_key');
        if(key) document.getElementById('apiKey').value = key;
        
        // Defaults
        document.getElementById('filmLanguage').value = "English";
        document.getElementById('diaLanguage').value = "English";
        document.getElementById('cineLanguage').value = "English";
        document.getElementById('ytLanguage').value = "English";
        document.getElementById('improveLang').value = "English";

        startTestimonials();
    };

    function startTestimonials() {
        let i = 0;
        setInterval(() => {
            const el = document.getElementById('testimonialText');
            el.style.animation = 'none';
            el.offsetHeight; /* trigger reflow */
            el.style.animation = 'fade 10s infinite';
            el.innerText = testimonials[i];
            i = (i + 1) % testimonials.length;
        }, 10000); // 10 Seconds
    }

    function handleLogin() {
        const u = document.getElementById('loginUser').value;
        const p = document.getElementById('loginPass').value;
        const users = JSON.parse(localStorage.getItem('nisff_users') || '[]');
        const valid = users.find(user => user.u === u && user.p === p);

        if (valid) {
            currentUser = u;
            localStorage.setItem('nisff_current_user', u);
            initApp();
        } else {
            document.getElementById('loginError').innerText = "Invalid Credentials";
        }
    }

    function initApp() {
        document.getElementById('login-wrapper').classList.add('hidden');
        document.getElementById('app-main').classList.remove('hidden');
        
        const userData = JSON.parse(localStorage.getItem(`nisff_data_${currentUser}`) || '{}');
        if (userData.photo) document.getElementById('userAvatarDisplay').src = userData.photo;
        
        ['film', 'dia', 'cine', 'imp', 'yt'].forEach(cat => updateHistoryUI(cat));
    }

    function logout() {
        localStorage.removeItem('nisff_current_user');
        location.reload();
    }

    function toggleProfileMenu() {
        const menu = document.getElementById('profile-menu');
        menu.style.display = (menu.style.display === 'block') ? 'none' : 'block';
    }
    function saveKey() {
        const key = document.getElementById('apiKey').value;
        localStorage.setItem('nisff_key', key);
    }
    function openPassModal() { document.getElementById('passModal').style.display = 'flex'; toggleProfileMenu(); }
    function openPhotoModal() { document.getElementById('photoModal').style.display = 'flex'; toggleProfileMenu(); }
    function closeModals() { document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); }

    function saveNewPassword() {
        const newPass = document.getElementById('newPassInput').value;
        if (!newPass) return alert("Enter password");
        let users = JSON.parse(localStorage.getItem('nisff_users') || '[]');
        const idx = users.findIndex(u => u.u === currentUser);
        if (idx !== -1) {
            users[idx].p = newPass;
            localStorage.setItem('nisff_users', JSON.stringify(users));
            alert("Updated!"); closeModals();
        }
    }

    function savePhoto() {
        const file = document.getElementById('photoInput').files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onloadend = function() {
            let userData = JSON.parse(localStorage.getItem(`nisff_data_${currentUser}`) || '{}');
            userData.photo = reader.result;
            localStorage.setItem(`nisff_data_${currentUser}`, JSON.stringify(userData));
            document.getElementById('userAvatarDisplay').src = reader.result;
            alert("Updated!"); closeModals();
        }
        reader.readAsDataURL(file);
    }

    function openTab(id) {
        document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(e => e.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        const btns = document.querySelectorAll('.tab-btn');
        btns.forEach(btn => {
            if(btn.onclick.toString().includes(id)) {
                btn.classList.add('active');
                btn.classList.remove('has-data');
            }
        });
    }

    function clearArea(outId, inId) {
        if(confirm('Clear contents?')) {
            document.getElementById(outId).innerText = "";
            if(inId) document.getElementById(inId).value = "";
        }
    }
    function copyText(id) { navigator.clipboard.writeText(document.getElementById(id).innerText); alert("Copied!"); }
    function printArea(id) {
        const content = document.getElementById(id).innerText;
        const win = window.open('', '', 'height=700,width=900');
        win.document.write(`<html><head><title>Print</title><style>body{font-family:'Courier New'; white-space: pre-wrap; padding:40px;}</style></head><body>${content}</body></html>`);
        win.document.close(); win.print();
    }

    function stripHtml(html) {
        return html.replace(/<[^>]*>?/gm, ''); 
    }

    async function callGemini(prompt) {
        const key = document.getElementById('apiKey').value;
        if (!key) { alert("Please enter API Key in Profile Menu"); return null; }

        let url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-lite:generateContent?key=${key}`;

        const payload = {
            contents: [{ parts: [{ text: prompt }] }],
            safetySettings: [
                { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_ONLY_HIGH" },
                { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_ONLY_HIGH" },
                { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_ONLY_HIGH" },
                { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_ONLY_HIGH" }
            ]
        };

        try {
            let response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            let data = await response.json();

            // FALLBACK
            if (data.error && (data.error.code === 404 || data.error.message.includes("not found"))) {
                url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${key}`;
                response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                data = await response.json();
            }

            if (data.error) { alert("Error: " + data.error.message); return null; }
            if (!data.candidates) { alert("No content."); return null; }
            
            return stripHtml(data.candidates[0].content.parts[0].text.replace(/\*\*/g, "")); 

        } catch (e) { alert("Error: " + e.message); return null; }
    }

    function getHistoryKey(category) { return `nisff_hist_${currentUser}_${category}`; }
    
    function addToHistory(category, text) {
        const key = getHistoryKey(category);
        let hist = JSON.parse(localStorage.getItem(key) || '[]');
        hist.unshift({ time: new Date().toLocaleTimeString(), full: text });
        if(hist.length > 10) hist.pop();
        localStorage.setItem(key, JSON.stringify(hist));
        updateHistoryUI(category);
    }

    function updateHistoryUI(category) {
        const key = getHistoryKey(category);
        let hist = JSON.parse(localStorage.getItem(key) || '[]');
        const select = document.getElementById(`hist-${category}`);
        while (select.options.length > 1) { select.remove(1); }
        hist.forEach((item, index) => {
            const opt = document.createElement('option');
            opt.value = index; opt.text = item.time;
            select.appendChild(opt);
        });
    }

    function restoreHistory(category) {
        const select = document.getElementById(`hist-${category}`);
        const index = select.value;
        if(index === "") return;
        const key = getHistoryKey(category);
        let hist = JSON.parse(localStorage.getItem(key));
        const idMap = { 'film': 'filmOutput', 'dia': 'diaOutput', 'cine': 'cineOutput', 'imp': 'improveOutput', 'yt': 'ytOutput' };
        document.getElementById(idMap[category]).innerText = hist[index].full;
    }

    function deleteHistoryItem(category) {
        const select = document.getElementById(`hist-${category}`);
        const index = select.value;
        if(index === "") return;
        if(confirm("Delete item?")) {
            const key = getHistoryKey(category);
            let hist = JSON.parse(localStorage.getItem(key));
            hist.splice(index, 1);
            localStorage.setItem(key, JSON.stringify(hist));
            const idMap = { 'film': 'filmOutput', 'dia': 'diaOutput', 'cine': 'cineOutput', 'imp': 'improveOutput', 'yt': 'ytOutput' };
            document.getElementById(idMap[category]).innerText = "";
            updateHistoryUI(category);
        }
    }

    function getStrictInstruction(lang) {
        if(lang === 'English') return "Write entirely in English.";
        if(lang === 'Hinglish') return "Write in Hinglish (Hindi words written in English alphabet).";
        
        return `
        STRICT LANGUAGE ENFORCEMENT:
        1. **Write ONLY in ${lang}**.
        2. Use the **Native ${lang} Script** (e.g., Assamese script for Assamese).
        3. Do NOT write dialogue in English unless absolutely necessary.
        4. No HTML tags.
        `;
    }

    async function generateFilm() {
        const idea = document.getElementById('filmIdea').value;
        const lang = document.getElementById('filmLanguage').value;
        const genre = document.getElementById('filmGenre').value;
        const dur = document.getElementById('filmDuration').value;

        if(!idea) return alert("Enter Idea");
        document.getElementById('filmLoader').style.display = 'block';
        
        const prompt = `Act as a Professional Screenwriter. Write a Short Film Script.
        Title: ${idea}. Genre: ${genre}. Duration: ${dur}.
        ${getStrictInstruction(lang)}
        Format: Standard Screenplay (Plain Text).`;

        const script = await callGemini(prompt);
        document.getElementById('filmLoader').style.display = 'none';
        
        if(script) {
            document.getElementById('filmOutput').innerText = script;
            addToHistory('film', script);
            
            document.getElementById('diaContext').value = `Script: ${idea}`;
            document.getElementById('diaLanguage').value = lang;
            document.getElementById('cineContext').value = `Script: ${idea}`;
            document.getElementById('cineLanguage').value = lang;
            
            autoGenerateCinematography(idea, genre, lang);
        }
    }

    async function autoGenerateCinematography(idea, genre, lang) {
        const btn = document.getElementById('btn-cinematography');
        // Strict inheritance: Uses the film's language
        const res = await callGemini(`Create a Shot List for film "${idea}" (${genre}). ${getStrictInstruction(lang)}`);
        if(res) {
            document.getElementById('cineOutput').innerText = res;
            addToHistory('cine', res);
            btn.classList.add('has-data');
        }
    }

    async function generateDialogue() {
        const ctx = document.getElementById('diaContext').value;
        const lang = document.getElementById('diaLanguage').value;
        document.getElementById('diaLoader').style.display = 'block';
        const res = await callGemini(`Write movie dialogues for: ${ctx}. ${getStrictInstruction(lang)}`);
        document.getElementById('diaLoader').style.display = 'none';
        if(res) { document.getElementById('diaOutput').innerText = res; addToHistory('dia', res); }
    }

    async function generateCinematography() {
        const ctx = document.getElementById('cineContext').value;
        const lang = document.getElementById('cineLanguage').value;
        document.getElementById('cineLoader').style.display = 'block';
        const res = await callGemini(`Create Shot List/Cinematography for: ${ctx}. ${getStrictInstruction(lang)}`);
        document.getElementById('cineLoader').style.display = 'none';
        if(res) { document.getElementById('cineOutput').innerText = res; addToHistory('cine', res); }
    }

    async function improveScript() {
        const input = document.getElementById('improveInput').value;
        const type = document.getElementById('improveType').value;
        const lang = document.getElementById('improveLang').value;
        if(!input) return alert("Paste script first");
        document.getElementById('improveLoader').style.display = 'block';
        const res = await callGemini(`Improve this script based on: ${type}. Rewrite in **${lang}** (Native Script). \n\n${input}`);
        document.getElementById('improveLoader').style.display = 'none';
        if(res) { document.getElementById('improveOutput').innerText = res; addToHistory('imp', res); }
    }

    async function generateYouTube() {
        const topic = document.getElementById('ytTopic').value;
        const lang = document.getElementById('ytLanguage').value;
        document.getElementById('ytLoader').style.display = 'block';
        const res = await callGemini(`Write YouTube script about: ${topic}. ${getStrictInstruction(lang)}`);
        document.getElementById('ytLoader').style.display = 'none';
        if(res) { document.getElementById('ytOutput').innerText = res; addToHistory('yt', res); }
    }

</script>
</body>
</html>
