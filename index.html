<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEXGN Script Writer Pro v13.0</title>
    <style>
        :root {
            --primary: #d4af37; /* Gold */
            --bg: #050505;
            --card: #141414;
            --text: #e0e0e0;
            --border: #333;
            --success: #00e676;
            --error: #ff5252;
        }

        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; height: 100vh; overflow: hidden; }
        .hidden { display: none !important; }
        button { cursor: pointer; }

        /* Animations */
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .reel-icon { display: inline-block; font-size: 24px; margin-left: 10px; animation: spin 4s linear infinite; vertical-align: middle; }
        
        /* Blinking Indicator */
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
        .has-data::after {
            content: ''; position: absolute; top: 8px; left: 8px;
            width: 10px; height: 10px; background-color: var(--success);
            border-radius: 50%; box-shadow: 0 0 8px var(--success);
            animation: blink 1.2s infinite;
        }

        /* Login Screen */
        #login-wrapper {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at center, #222 0%, #000 70%); z-index: 1000;
            display: flex; align-items: center; justify-content: center;
        }
        .login-box {
            background: var(--card); padding: 40px; border-radius: 12px;
            border: 1px solid var(--primary); text-align: center; width: 400px;
            box-shadow: 0 0 30px rgba(212, 175, 55, 0.2);
        }
        .login-input { width: 100%; padding: 12px; margin-bottom: 15px; background: #222; border: 1px solid #444; color: #fff; border-radius: 6px; box-sizing: border-box; }
        .login-btn { width: 100%; padding: 12px; background: var(--primary); color: #000; font-weight: bold; border: none; border-radius: 6px; transition: 0.3s; }
        .login-btn:hover { background: #fff; }

        /* Dashboard */
        .app-shell { max-width: 1200px; margin: 20px auto; background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 20px; height: 90vh; display: flex; flex-direction: column; position: relative; }
        
        /* NEXGN Watermark */
        .nexgn-watermark {
            position: absolute;
            top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 150px; font-weight: 900;
            color: rgba(255, 255, 255, 0.03);
            pointer-events: none; z-index: 0;
            letter-spacing: 10px; user-select: none;
        }

        .header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 15px; border-bottom: 1px solid var(--border); margin-bottom: 15px; z-index: 2; position: relative; }
        h1 { margin: 0; font-size: 22px; background: linear-gradient(45deg, #fff, var(--primary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; display: flex; align-items: center; }
        
        .user-controls { display: flex; align-items: center; gap: 15px; position: relative; }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary); cursor: pointer; }
        
        /* Profile Menu */
        #profile-menu {
            position: absolute; top: 60px; right: 0; background: #1a1a1a;
            border: 1px solid var(--primary); border-radius: 8px; width: 250px;
            padding: 15px; display: none; z-index: 9999; 
            box-shadow: 0 5px 20px rgba(0,0,0,0.9);
        }
        #profile-menu h4 { margin: 0 0 10px 0; color: var(--primary); font-size: 14px; border-bottom: 1px solid #333; padding-bottom: 5px; }
        #profile-menu button { width: 100%; padding: 10px; text-align: left; background: transparent; border: none; color: #fff; border-bottom: 1px solid #333; cursor: pointer; }
        #profile-menu button:hover { background: #333; }
        .key-section { margin-bottom: 10px; }
        .key-input { width: 100%; background: #000; border: 1px solid #444; color: var(--success); padding: 8px; border-radius: 4px; font-family: monospace; box-sizing: border-box; }

        /* Tabs */
        .nav-tabs { display: flex; gap: 5px; margin-bottom: 15px; z-index: 1; position: relative; }
        .tab-btn { flex: 1; padding: 12px; background: #111; border: 1px solid #333; color: #888; border-radius: 6px; transition: 0.3s; position: relative; }
        .tab-btn.active { background: var(--primary); color: #000; font-weight: bold; border-color: var(--primary); }
        .tab-btn:hover { background: #222; color: #fff; }

        .tab-content { display: none; padding: 10px; flex-grow: 1; overflow-y: auto; z-index: 1; position: relative; }
        .tab-content.active { display: block; }

        /* Inputs */
        .input-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        .full-width { grid-column: span 3; }
        label { display: block; font-size: 11px; color: var(--primary); margin-bottom: 5px; font-weight: bold; }
        input, select, textarea { width: 100%; background: #222; border: 1px solid var(--border); color: #fff; padding: 10px; border-radius: 6px; box-sizing: border-box; }
        
        .action-btn { width: 100%; padding: 15px; background: var(--primary); color: #000; font-weight: bold; border: none; border-radius: 6px; font-size: 16px; margin-top: 10px; }
        
        /* Output & Tools */
        .toolbar { display: flex; justify-content: flex-end; margin-top: 10px; gap: 5px; align-items: center; }
        .tool-group { display: flex; gap: 5px; }
        .history-select { background: #111; color: #aaa; border: 1px solid #444; padding: 5px; border-radius: 4px; font-size: 12px; width: 200px; }
        .sm-btn { background: #333; color: #fff; padding: 5px 10px; border-radius: 4px; border: 1px solid #555; font-size: 12px; }
        .del-btn { background: #b00020; border-color: #790000; color: white; padding: 5px 10px; border-radius: 4px; cursor: pointer; }

        .output-box { background: #000; border: 1px solid var(--border); padding: 25px; border-radius: 8px; margin-top: 5px; min-height: 300px; white-space: pre-wrap; font-family: 'Courier New', monospace; color: #ccc; font-size: 15px; line-height: 1.6; }
        .loader { display: none; text-align: center; color: var(--primary); margin-top: 10px; font-weight: bold; animation: pulse 1s infinite; }
        @keyframes pulse { 50% { opacity: 0.5; } }

        /* Modal */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: none; align-items: center; justify-content: center; }
        .modal-box { background: #1a1a1a; padding: 30px; border-radius: 10px; width: 300px; text-align: center; border: 1px solid var(--primary); }
    </style>
</head>
<body>

<div id="login-wrapper">
    <div class="login-box">
        <h2>NEXGN SCRIPT WRITER PRO v13.0 <span class="reel-icon">üéûÔ∏è</span></h2>
        <input type="text" id="loginUser" class="login-input" placeholder="Username">
        <input type="password" id="loginPass" class="login-input" placeholder="Password">
        <button class="login-btn" onclick="handleLogin()">LOGIN</button>
        <div id="loginError" style="color:var(--error); margin-top:10px;"></div>
    </div>
</div>

<div class="app-shell hidden" id="app-main">
    <div class="nexgn-watermark">NEXGN</div>
    
    <div class="header">
        <h1>NEXGN Script Writer Pro <span class="reel-icon">üéûÔ∏è</span></h1>
        <div class="user-controls">
            <span id="welcomeUser" style="font-size:12px; color:#888;"></span>
            <img id="userAvatarDisplay" src="https://api.dicebear.com/7.x/avataaars/svg?seed=User" class="user-avatar" onclick="toggleProfileMenu()">
            
            <div id="profile-menu">
                <h4>Profile & Settings</h4>
                <div class="key-section">
                    <label>Insert key here</label>
                    <input type="password" id="apiKey" class="key-input" placeholder="Enter API Key" onchange="saveKey()">
                </div>
                <button onclick="openPhotoModal()">üì∑ Change Photo</button>
                <button onclick="openPassModal()">üîë Change Password</button>
                <button onclick="logout()" style="color:var(--error)">üö™ Logout</button>
            </div>
        </div>
    </div>

    <div class="nav-tabs">
        <button class="tab-btn active" onclick="openTab('film')">üé¨ Short Film</button>
        <button class="tab-btn" id="btn-dialogue" onclick="openTab('dialogue')">üó£Ô∏è Dialogue</button>
        <button class="tab-btn" id="btn-cinematography" onclick="openTab('cinematography')">üé• Cinematography</button>
        <button class="tab-btn" onclick="openTab('mini')">üì± Mini/Reels</button>
        <button class="tab-btn" onclick="openTab('youtube')">üìπ YouTube</button>
    </div>

    <datalist id="languageOptions">
        <option value="English">English</option>
        <option value="Hindi">Hindi (‡§π‡§ø‡§®‡•ç‡§¶‡•Ä)</option>
        <option value="Marathi">Marathi (‡§Æ‡§∞‡§æ‡§†‡•Ä)</option>
        <option value="Bengali">Bengali (‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ)</option>
        <option value="Tamil">Tamil (‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç)</option>
        <option value="Telugu">Telugu (‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å)</option>
        <option value="Gujarati">Gujarati (‡™ó‡´Å‡™ú‡™∞‡™æ‡™§‡´Ä)</option>
        <option value="Urdu">Urdu (ÿßÿ±ÿØŸà)</option>
        <option value="Kannada">Kannada (‡≤ï‡≤®‡≥ç‡≤®‡≤°)</option>
        <option value="Odia">Odia (‡¨ì‡¨°‡¨º‡¨ø‡¨Ü)</option>
        <option value="Malayalam">Malayalam (‡¥Æ‡¥≤‡¥Ø‡¥æ‡¥≥‡¥Ç)</option>
        <option value="Punjabi">Punjabi (‡®™‡©∞‡®ú‡®æ‡®¨‡©Ä)</option>
        <option value="Assamese">Assamese (‡¶Ö‡¶∏‡¶Æ‡ßÄ‡¶Ø‡¶º‡¶æ)</option>
        <option value="Maithili">Maithili (‡§Æ‡•à‡§•‡§ø‡§≤‡•Ä)</option>
        <option value="Santali">Santali (‡§∏‡§Ç‡§•‡§æ‡§≤‡•Ä)</option>
        <option value="Kashmiri">Kashmiri (‡§ï‡§∂‡•ç‡§Æ‡•Ä‡§∞‡•Ä)</option>
        <option value="Nepali">Nepali (‡§®‡•á‡§™‡§æ‡§≤‡•Ä)</option>
        <option value="Konkani">Konkani (‡§ï‡•ã‡§Ç‡§ï‡§£‡•Ä)</option>
        <option value="Sindhi">Sindhi (‡§∏‡§ø‡§Ç‡§ß‡•Ä)</option>
        <option value="Dogri">Dogri (‡§°‡•ã‡§ó‡§∞‡•Ä)</option>
        <option value="Manipuri">Manipuri (‡¶Æ‡¶£‡¶ø‡¶™‡ßÅ‡¶∞‡ßÄ)</option>
        <option value="Bodo">Bodo (‡§¨‡§∞')</option>
        <option value="Sanskrit">Sanskrit (‡§∏‡§Ç‡§∏‡•ç‡§ï‡•É‡§§)</option>
    </datalist>

    <div id="film" class="tab-content active">
        <div class="input-grid">
            <div class="full-width">
                <label>Movie Idea / Logline</label>
                <textarea id="filmIdea" rows="2" placeholder="e.g. A young boy finds a magical flute..."></textarea>
            </div>
            <div>
                <label>Genre</label>
                <select id="filmGenre">
                    <option>Drama</option><option>Sci-Fi</option><option>Horror</option>
                    <option>Comedy</option><option>Thriller</option><option>Romance</option>
                    <option>Action</option><option>Animation</option><option>Fantasy</option>
                    <option>Mystery</option><option>Historical</option><option>Noir</option>
                </select>
            </div>
            <div>
                <label>Duration</label>
                <select id="filmDuration">
                    <option>10 Minutes</option><option>15 Minutes</option><option>20 Minutes</option>
                    <option>25 Minutes</option><option>30 Minutes</option><option>35 Minutes</option><option>40 Minutes</option>
                </select>
            </div>
            <div>
                <label>Spoken Language (Dialect)</label>
                <input list="languageOptions" id="filmAudioLang" placeholder="e.g. Mumbai Hindi">
            </div>
            <div>
                <label>Script Output Format</label>
                <input list="languageOptions" id="filmScriptLang" placeholder="e.g. English">
            </div>
        </div>
        <button class="action-btn" onclick="generateFilm()">GENERATE SCRIPT + ASSETS</button>
        <div id="filmLoader" class="loader">WRITING SCREENPLAY...</div>
        <div class="toolbar">
            <select id="hist-film" class="history-select" onchange="restoreHistory('film')"><option value="">üïí Recent Scripts</option></select>
            <button class="del-btn" onclick="deleteHistoryItem('film')" title="Delete selected">‚ùå</button>
            <div class="tool-group">
                <button class="sm-btn" onclick="clearArea('filmOutput', 'filmIdea')">üóëÔ∏è Clear</button>
                <button class="sm-btn" onclick="printArea('filmOutput')">üñ®Ô∏è Print</button>
                <button class="sm-btn" onclick="copyText('filmOutput')">üìã Copy</button>
            </div>
        </div>
        <div id="filmOutput" class="output-box"></div>
    </div>

    <div id="dialogue" class="tab-content">
        <div class="input-grid">
            <div class="full-width"><label>Context</label><textarea id="diaContext" rows="3"></textarea></div>
            <div><label>Spoken Language</label><input list="languageOptions" id="diaAudioLang"></div>
            <div><label>Script Format</label><input list="languageOptions" id="diaScriptLang"></div>
        </div>
        <button class="action-btn" onclick="generateDialogue()">GENERATE DIALOGUES</button>
        <div id="diaLoader" class="loader">WRITING...</div>
        <div class="toolbar">
            <select id="hist-dia" class="history-select" onchange="restoreHistory('dia')"><option>üïí Recent Scripts</option></select>
            <button class="del-btn" onclick="deleteHistoryItem('dia')">‚ùå</button>
            <div class="tool-group">
                <button class="sm-btn" onclick="clearArea('diaOutput', 'diaContext')">üóëÔ∏è Clear</button>
                <button class="sm-btn" onclick="printArea('diaOutput')">üñ®Ô∏è Print</button>
                <button class="sm-btn" onclick="copyText('diaOutput')">üìã Copy</button>
            </div>
        </div>
        <div id="diaOutput" class="output-box"></div>
    </div>

    <div id="cinematography" class="tab-content">
        <div class="input-grid">
            <div class="full-width"><label>Script Context</label><textarea id="cineContext" rows="3"></textarea></div>
            <div class="full-width"><label>Output Language</label><input list="languageOptions" id="cineLanguage"></div>
        </div>
        <button class="action-btn" onclick="generateCinematography()">GENERATE SHOTS</button>
        <div id="cineLoader" class="loader">PLANNING...</div>
        <div class="toolbar">
            <select id="hist-cine" class="history-select" onchange="restoreHistory('cine')"><option>üïí Recent Scripts</option></select>
            <button class="del-btn" onclick="deleteHistoryItem('cine')">‚ùå</button>
            <div class="tool-group">
                <button class="sm-btn" onclick="clearArea('cineOutput', 'cineContext')">üóëÔ∏è Clear</button>
                <button class="sm-btn" onclick="printArea('cineOutput')">üñ®Ô∏è Print</button>
                <button class="sm-btn" onclick="copyText('cineOutput')">üìã Copy</button>
            </div>
        </div>
        <div id="cineOutput" class="output-box"></div>
    </div>

    <div id="mini" class="tab-content">
        <div class="input-grid">
            <div class="full-width"><label>Topic</label><input type="text" id="miniTopic"></div>
            <div><label>Duration</label><select id="miniDuration">
                <option>20 Seconds</option><option>30 Seconds</option><option>40 Seconds</option>
                <option>50 Seconds</option><option>60 Seconds</option>
            </select></div>
            <div><label>Category</label><select id="miniCategory"><option>Comedy</option><option>Tech</option><option>Education</option></select></div>
            <div><label>Spoken Language</label><input list="languageOptions" id="miniAudioLang"></div>
            <div><label>Script Format</label><input list="languageOptions" id="miniScriptLang"></div>
        </div>
        <button class="action-btn" onclick="generateMini()">GENERATE REELS</button>
        <div id="miniLoader" class="loader">CREATING...</div>
        <div class="toolbar">
            <select id="hist-mini" class="history-select" onchange="restoreHistory('mini')"><option>üïí Recent Scripts</option></select>
            <button class="del-btn" onclick="deleteHistoryItem('mini')">‚ùå</button>
            <div class="tool-group">
                <button class="sm-btn" onclick="clearArea('miniOutput', 'miniTopic')">üóëÔ∏è Clear</button>
                <button class="sm-btn" onclick="printArea('miniOutput')">üñ®Ô∏è Print</button>
                <button class="sm-btn" onclick="copyText('miniOutput')">üìã Copy</button>
            </div>
        </div>
        <div id="miniOutput" class="output-box"></div>
    </div>

    <div id="youtube" class="tab-content">
        <div class="input-grid">
            <div class="full-width"><label>Title</label><input type="text" id="ytTopic"></div>
            <div><label>Duration</label><select id="ytDuration"><option>10 Min</option><option>20 Min</option><option>30 Min</option></select></div>
            <div><label>Category</label><select id="ytCategory"><option>Vlog</option><option>Tech</option><option>Docu</option></select></div>
            <div><label>Spoken Language</label><input list="languageOptions" id="ytAudioLang"></div>
            <div><label>Script Format</label><input list="languageOptions" id="ytScriptLang"></div>
        </div>
        <button class="action-btn" onclick="generateYouTube()">GENERATE SCRIPT</button>
        <div id="ytLoader" class="loader">WRITING...</div>
        <div class="toolbar">
            <select id="hist-yt" class="history-select" onchange="restoreHistory('yt')"><option>üïí Recent Scripts</option></select>
            <button class="del-btn" onclick="deleteHistoryItem('yt')">‚ùå</button>
            <div class="tool-group">
                <button class="sm-btn" onclick="clearArea('ytOutput', 'ytTopic')">üóëÔ∏è Clear</button>
                <button class="sm-btn" onclick="printArea('ytOutput')">üñ®Ô∏è Print</button>
                <button class="sm-btn" onclick="copyText('ytOutput')">üìã Copy</button>
            </div>
        </div>
        <div id="ytOutput" class="output-box"></div>
    </div>

</div>

<div id="passModal" class="modal">
    <div class="modal-box">
        <h3>Change Password</h3>
        <input type="password" id="newPassInput" class="login-input" placeholder="New Password">
        <button class="login-btn" onclick="saveNewPassword()">Save</button>
        <button class="login-btn" style="background:#333; margin-top:10px;" onclick="closeModals()">Cancel</button>
    </div>
</div>

<div id="photoModal" class="modal">
    <div class="modal-box">
        <h3>Upload Photo</h3>
        <input type="file" id="photoInput" class="login-input" accept="image/*">
        <button class="login-btn" onclick="savePhoto()">Upload</button>
        <button class="login-btn" style="background:#333; margin-top:10px;" onclick="closeModals()">Cancel</button>
    </div>
</div>

<script>
    let currentUser = null;

    // --- INIT ---
    window.onload = () => {
        const sessionUser = localStorage.getItem('nisff_current_user');
        if (sessionUser) {
            currentUser = sessionUser;
            initApp();
        }
        const key = localStorage.getItem('nisff_key');
        if(key) document.getElementById('apiKey').value = key;
        
        // Defaults
        document.getElementById('filmAudioLang').value = "Hindi";
        document.getElementById('filmScriptLang').value = "English";
    };

    function handleLogin() {
        const u = document.getElementById('loginUser').value;
        const p = document.getElementById('loginPass').value;
        const users = JSON.parse(localStorage.getItem('nisff_users') || '[]');
        const valid = users.find(user => user.u === u && user.p === p);

        if (valid) {
            currentUser = u;
            localStorage.setItem('nisff_current_user', u);
            initApp();
        } else {
            document.getElementById('loginError').innerText = "Invalid Credentials";
        }
    }

    function initApp() {
        document.getElementById('login-wrapper').classList.add('hidden');
        document.getElementById('app-main').classList.remove('hidden');
        document.getElementById('welcomeUser').innerText = `User: ${currentUser}`;
        const userData = JSON.parse(localStorage.getItem(`nisff_data_${currentUser}`) || '{}');
        if (userData.photo) document.getElementById('userAvatarDisplay').src = userData.photo;
        if (userData.apiKey) document.getElementById('apiKey').value = userData.apiKey;
        
        ['film', 'dia', 'cine', 'mini', 'yt'].forEach(cat => updateHistoryUI(cat));
    }

    function logout() { localStorage.removeItem('nisff_current_user'); location.reload(); }
    
    // --- PROFILE ---
    function toggleProfileMenu() {
        const menu = document.getElementById('profile-menu');
        menu.style.display = (menu.style.display === 'block') ? 'none' : 'block';
    }
    function saveKey() {
        const key = document.getElementById('apiKey').value;
        let userData = JSON.parse(localStorage.getItem(`nisff_data_${currentUser}`) || '{}');
        userData.apiKey = key;
        localStorage.setItem(`nisff_data_${currentUser}`, JSON.stringify(userData));
        localStorage.setItem('nisff_key', key);
    }
    function openPassModal() { document.getElementById('passModal').style.display = 'flex'; toggleProfileMenu(); }
    function openPhotoModal() { document.getElementById('photoModal').style.display = 'flex'; toggleProfileMenu(); }
    function closeModals() { document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); }

    function saveNewPassword() {
        const newPass = document.getElementById('newPassInput').value;
        if (!newPass) return alert("Enter password");
        let users = JSON.parse(localStorage.getItem('nisff_users') || '[]');
        const idx = users.findIndex(u => u.u === currentUser);
        if (idx !== -1) {
            users[idx].p = newPass;
            localStorage.setItem('nisff_users', JSON.stringify(users));
            alert("Updated!"); closeModals();
        }
    }

    function savePhoto() {
        const file = document.getElementById('photoInput').files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onloadend = function() {
            let userData = JSON.parse(localStorage.getItem(`nisff_data_${currentUser}`) || '{}');
            userData.photo = reader.result;
            localStorage.setItem(`nisff_data_${currentUser}`, JSON.stringify(userData));
            document.getElementById('userAvatarDisplay').src = reader.result;
            alert("Updated!"); closeModals();
        }
        reader.readAsDataURL(file);
    }

    // --- UI UTILS ---
    function openTab(id) {
        document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(e => e.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        const btns = document.querySelectorAll('.tab-btn');
        btns.forEach(btn => {
            if(btn.onclick.toString().includes(id)) {
                btn.classList.add('active');
                btn.classList.remove('has-data');
            }
        });
    }

    function clearArea(outId, inId) {
        if(confirm('Clear?')) {
            document.getElementById(outId).innerText = "";
            if(inId) document.getElementById(inId).value = "";
        }
    }
    function copyText(id) { navigator.clipboard.writeText(document.getElementById(id).innerText); alert("Copied!"); }
    function printArea(id) {
        const content = document.getElementById(id).innerText;
        const win = window.open('', '', 'height=700,width=900');
        win.document.write(`<html><head><title>Print</title><style>body{font-family:'Courier New'; white-space: pre-wrap; padding:40px;}</style></head><body>${content}</body></html>`);
        win.document.close(); win.print();
    }

    // --- API CALL ---
    async function callGemini(prompt) {
        const key = document.getElementById('apiKey').value;
        if (!key) { alert("Enter API Key in Profile"); return null; }

        // REQUESTED MODEL: gemini-2.5-flash-lite
        let url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-lite:generateContent?key=${key}`;

        const payload = {
            contents: [{ parts: [{ text: prompt }] }],
            safetySettings: [
                { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_ONLY_HIGH" },
                { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_ONLY_HIGH" },
                { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_ONLY_HIGH" },
                { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_ONLY_HIGH" }
            ]
        };

        try {
            let response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            let data = await response.json();

            // FALLBACK TO 1.5 FLASH IF 2.5 FAILS (404 Not Found)
            if (data.error && (data.error.code === 404 || data.error.message.includes("not found"))) {
                console.warn("2.5-lite failed, falling back to 1.5-flash");
                url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${key}`;
                response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                data = await response.json();
            }

            if (data.error) { alert("Error: " + data.error.message); return null; }
            if (!data.candidates) { alert("No content."); return null; }
            
            return data.candidates[0].content.parts[0].text;

        } catch (e) { alert("Network Error"); return null; }
    }

    // --- HISTORY ---
    function getHistoryKey(category) { return `nisff_hist_${currentUser}_${category}`; }
    
    function addToHistory(category, text) {
        const key = getHistoryKey(category);
        let hist = JSON.parse(localStorage.getItem(key) || '[]');
        hist.unshift({ time: new Date().toLocaleString(), full: text });
        if(hist.length > 10) hist.pop();
        localStorage.setItem(key, JSON.stringify(hist));
        updateHistoryUI(category);
    }

    function updateHistoryUI(category) {
        const key = getHistoryKey(category);
        let hist = JSON.parse(localStorage.getItem(key) || '[]');
        const select = document.getElementById(`hist-${category}`);
        select.innerHTML = '<option value="">üïí Recent Scripts</option>';
        hist.forEach((item, index) => {
            const opt = document.createElement('option');
            opt.value = index; opt.text = item.time;
            select.appendChild(opt);
        });
    }

    function restoreHistory(category) {
        const select = document.getElementById(`hist-${category}`);
        const index = select.value;
        if(index === "") return;
        const key = getHistoryKey(category);
        let hist = JSON.parse(localStorage.getItem(key));
        const idMap = { 'film': 'filmOutput', 'dia': 'diaOutput', 'cine': 'cineOutput', 'mini': 'miniOutput', 'yt': 'ytOutput' };
        document.getElementById(idMap[category]).innerText = hist[index].full;
    }

    function deleteHistoryItem(category) {
        const select = document.getElementById(`hist-${category}`);
        const index = select.value;
        if(index === "") return;
        if(confirm("Delete item?")) {
            const key = getHistoryKey(category);
            let hist = JSON.parse(localStorage.getItem(key));
            hist.splice(index, 1);
            localStorage.setItem(key, JSON.stringify(hist));
            const idMap = { 'film': 'filmOutput', 'dia': 'diaOutput', 'cine': 'cineOutput', 'mini': 'miniOutput', 'yt': 'ytOutput' };
            document.getElementById(idMap[category]).innerText = "";
            updateHistoryUI(category);
        }
    }

    // --- GENERATORS (DUAL LANGUAGE SUPPORT) ---
    function getPrompt(type, params) {
        const langInstruction = `
        STRICT LANGUAGE RULES:
        1. **Spoken Dialogue/Audio**: MUST be in **${params.audioLang}**.
        2. **Script Description/Action Lines**: MUST be in **${params.scriptLang}**.
        Example: If Audio is Hindi and Script is English -> Dialogue: "Kya hua?" | Action: He looks confused.
        `;

        if (type === 'film') {
            return `Write a Short Film Script. Title: ${params.idea}. Genre: ${params.genre}. Duration: ${params.dur}.
            ${langInstruction} Format: Standard Screenplay. NO HTML.`;
        }
        if (type === 'dia') {
            return `Write dialogue based on: ${params.ctx}. ${langInstruction} Format: Screenplay Dialogue.`;
        }
        if (type === 'cine') {
            return `Create a Shot List for: ${params.ctx}. Language: ${params.scriptLang}. Format: Shot Type | Description.`;
        }
        if (type === 'mini') {
            return `Write a ${params.dur} Reels Script. Topic: ${params.topic}. Category: ${params.cat}. ${langInstruction}`;
        }
        if (type === 'yt') {
            return `Write a ${params.dur} YouTube Script. Title: ${params.topic}. Category: ${params.cat}. ${langInstruction}`;
        }
    }

    async function generateFilm() {
        const idea = document.getElementById('filmIdea').value;
        const audioLang = document.getElementById('filmAudioLang').value;
        const scriptLang = document.getElementById('filmScriptLang').value;
        
        if(!idea) return alert("Enter Idea");
        document.getElementById('filmLoader').style.display = 'block';
        
        const prompt = getPrompt('film', { 
            idea, audioLang, scriptLang, 
            genre: document.getElementById('filmGenre').value, 
            dur: document.getElementById('filmDuration').value 
        });

        const script = await callGemini(prompt);
        document.getElementById('filmLoader').style.display = 'none';
        
        if(script) {
            document.getElementById('filmOutput').innerText = script;
            addToHistory('film', script);
            
            // Auto Trigger
            document.getElementById('diaContext').value = `Script: ${idea}`;
            document.getElementById('diaAudioLang').value = audioLang;
            document.getElementById('diaScriptLang').value = scriptLang;
            
            document.getElementById('cineContext').value = `Script: ${idea}`;
            document.getElementById('cineLanguage').value = scriptLang;
            
            // Trigger background
            autoGen(script, audioLang, scriptLang);
        }
    }

    async function autoGen(script, aLang, sLang) {
        // Dialogue
        const diaPrompt = `Extract 3 dialogues from: ${script.substring(0,500)}. Spoken: ${aLang}. Text: ${sLang}.`;
        const diaRes = await callGemini(diaPrompt);
        if(diaRes) {
            document.getElementById('diaOutput').innerText = diaRes;
            addToHistory('dia', diaRes);
            document.getElementById('btn-dialogue').classList.add('has-data');
        }
        
        // Cine
        const cinePrompt = `Create 5 shots for this script. Language: ${sLang}.`;
        const cineRes = await callGemini(cinePrompt);
        if(cineRes) {
            document.getElementById('cineOutput').innerText = cineRes;
            addToHistory('cine', cineRes);
            document.getElementById('btn-cinematography').classList.add('has-data');
        }
    }

    async function generateDialogue() {
        const ctx = document.getElementById('diaContext').value;
        const audioLang = document.getElementById('diaAudioLang').value;
        const scriptLang = document.getElementById('diaScriptLang').value;
        document.getElementById('diaLoader').style.display = 'block';
        const res = await callGemini(getPrompt('dia', { ctx, audioLang, scriptLang }));
        document.getElementById('diaLoader').style.display = 'none';
        if(res) { document.getElementById('diaOutput').innerText = res; addToHistory('dia', res); }
    }

    async function generateCinematography() {
        const ctx = document.getElementById('cineContext').value;
        const scriptLang = document.getElementById('cineLanguage').value;
        document.getElementById('cineLoader').style.display = 'block';
        const res = await callGemini(getPrompt('cine', { ctx, scriptLang }));
        document.getElementById('cineLoader').style.display = 'none';
        if(res) { document.getElementById('cineOutput').innerText = res; addToHistory('cine', res); }
    }

    async function generateMini() {
        const topic = document.getElementById('miniTopic').value;
        const audioLang = document.getElementById('miniAudioLang').value;
        const scriptLang = document.getElementById('miniScriptLang').value;
        document.getElementById('miniLoader').style.display = 'block';
        const res = await callGemini(getPrompt('mini', { 
            topic, audioLang, scriptLang, 
            dur: document.getElementById('miniDuration').value, 
            cat: document.getElementById('miniCategory').value 
        }));
        document.getElementById('miniLoader').style.display = 'none';
        if(res) { document.getElementById('miniOutput').innerText = res; addToHistory('mini', res); }
    }

    async function generateYouTube() {
        const topic = document.getElementById('ytTopic').value;
        const audioLang = document.getElementById('ytAudioLang').value;
        const scriptLang = document.getElementById('ytScriptLang').value;
        document.getElementById('ytLoader').style.display = 'block';
        const res = await callGemini(getPrompt('yt', { 
            topic, audioLang, scriptLang, 
            dur: document.getElementById('ytDuration').value, 
            cat: document.getElementById('ytCategory').value 
        }));
        document.getElementById('ytLoader').style.display = 'none';
        if(res) { document.getElementById('ytOutput').innerText = res; addToHistory('yt', res); }
    }

</script>
</body>
</html>
